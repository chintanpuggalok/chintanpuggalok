name: Publish to dev.to

on:
  push:
    branches:
      - url-forwarding

jobs:
  publish:
    if: "!contains(github.event.head_commit.message, 'Add article ID to latest article')"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Find latest article by commit date
      run: |
        cd $GITHUB_WORKSPACE
        latest_article=$(git log -1 --pretty=format: --name-only -- content/blogs/**/*.md | grep -v 'content/blogs/_index.md' | head -n 1)
        if [ -z "$latest_article" ]; then
          echo "No article found"
          exit 1
        fi
        cp "$latest_article" latest_article.md

    - name: Replace relative paths with GitHub raw content URLs
      run: |
        cd $GITHUB_WORKSPACE
        repo_url="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/"
        latest_article_dir=$(dirname "$latest_article")

        # Debugging: Print the latest_article and latest_article_dir
        echo "Latest article: $latest_article"
        echo "Latest article directory: $latest_article_dir"

        # Ensure the directory path is correct
        if [ -z "$latest_article_dir" ] || [ "$latest_article_dir" = "." ]; then
          latest_article_dir=$(dirname "$latest_article")
        fi

        # Update the sed command to remove ./ while replacing
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s|!\[\([^]]*\)\](\(\./[^)]*\))|![\1]($repo_url$latest_article_dir/\2)|g" latest_article.md
        else
          sed -i "s|!\[\([^]]*\)\](\(\./[^)]*\))|![\1]($repo_url$latest_article_dir/\2)|g" latest_article.md
        fi

    - name: Extract title from article
      run: |
        title=$(grep -m 1 '^title: ' latest_article.md | sed 's/^title: //')
        description=$(grep -m 1 '^description: ' latest_article.md | sed 's/^description: //')
        tags=$(grep -m 1 '^tags: ' latest_article.md | sed 's/^tags: //' | jq -R 'split(",")' | jq -c '.')
        echo "title=$title" >> $GITHUB_ENV
        echo "description=$description" >> $GITHUB_ENV
        echo "tags=$tags" >> $GITHUB_ENV

    - name: Publish to dev.to
      env:
        DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
        title: ${{ env.title }}
        description: ${{ env.description }}
        tags: ${{ env.tags }}
      run: |
        request_body=$(cat <<EOF
        {
          "article": {
            "title": "${{ env.title }}",
            "description": "${{ env.description }}",
            "tags": ${{ env.tags }},
            "published": true,
            "body_markdown": "$(cat latest_article.md)"
          }
        }
        EOF
        )
        echo "$request_body"
        response=$(curl -X POST \
          -H "Content-Type: application/json" \
          -H "api-key: $DEVTO_API_KEY" \
          -d "$request_body" https://dev.to/api/articles)
        if [ $? -eq 0 ]; then
          article_id=$(echo $response | jq -r '.id')
          echo "id: $article_id" | cat - latest_article.md > temp && mv temp latest_article.md
          if [ ! -d "$latest_article" ]; then
            echo "id: $article_id" | cat - latest_article.md > temp && mv temp "$latest_article"
          else
            echo "Cannot overwrite directory with non-directory"
            exit 1
          fi
        else
          echo "Failed to publish article to dev.to"
          exit 1
        fi

    - name: Commit changes
      run: |
        echo "Article body before committing:"
        cat latest_article.md
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add $latest_article
        git commit -m "Add article ID to latest article [skip ci]"
        git push origin main